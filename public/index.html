<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Master Mix</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<script>
// üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
if (!localStorage.getItem("token")) {
  window.location.href = "/login.html";
}
</script>

<!-- ===== HEADER ===== -->
<div class="header">
  <div class="header-left">
    <img src="/images/mmlogo.png" class="logo">
    <span>Master Mix Logistics</span>
  </div>
  <button onclick="logout()" class="logout-btn">–í—ã–π—Ç–∏</button>
</div>

<!-- ===== –í–ï–†–•–ù–ò–ô –ë–õ–û–ö ===== -->
<div class="top-section">

  <!-- –î–û–ë–ê–í–õ–ï–ù–ò–ï -->
  <div class="add-block">
    <h2>–î–æ–±–∞–≤–∏—Ç—å –º–∞—à–∏–Ω—É</h2>

    <input id="name" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ">
    <input id="vin" placeholder="VIN">
    <input id="company" placeholder="–ö–æ–º–ø–∞–Ω–∏—è">

    <select id="transport_type">
      <option value="regular">–û–±—ã—á–Ω–∞—è</option>
      <option value="tral">–¢—Ä–∞–ª</option>
    </select>

    <select id="status">
      <option value="–ì—Ä–∞–Ω–∏—Ü–∞ –ò—Ä–∫–µ—à—Ç–∞–º">–ì—Ä–∞–Ω–∏—Ü–∞ –ò—Ä–∫–µ—à—Ç–∞–º</option>
      <option value="–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã">–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã</option>
      <option value="–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ">–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ</option>
      <option value="–ü–æ–ª—É—á–µ–Ω–æ —Å–ø–µ—Ü—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ú–∏–Ω—Ç—Ä–∞–Ω—Å">–ú–∏–Ω—Ç—Ä–∞–Ω—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ</option>
      <option value="–í –ø—É—Ç–∏">–í –ø—É—Ç–∏</option>
      <option value="–°—Ç–æ—è–Ω–∫–∞ –ö–∞—Ä–∞—Ç–∞–π">–°—Ç–æ—è–Ω–∫–∞ –ö–∞—Ä–∞—Ç–∞–π</option>
      <option value="–†–∞—Å—Ç–∞–º–æ–∂–∫–∞">–†–∞—Å—Ç–∞–º–æ–∂–∫–∞</option>
      <option value="–†–∞—Å—Ç–∞–º–æ–∂–µ–Ω–∞">–†–∞—Å—Ç–∞–º–æ–∂–µ–Ω–∞</option>
      <option value="–ù–∞ –±–∞–∑–µ –∫–æ–º–ø–∞–Ω–∏–∏">–ù–∞ –±–∞–∑–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>
      <option value="–ü–µ—Ä–µ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∞">–ü–µ—Ä–µ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∞</option>
    </select>

    <div id="cargoFields" style="display:none;">
      <input id="cargo_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞">
      <input id="cargo_weight" placeholder="–í–µ—Å (—Ç–æ–Ω–Ω—ã)">
      <input id="cargo_size" placeholder="–ì–∞–±–∞—Ä–∏—Ç—ã">
    </div>

    <button onclick="addVehicle()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>

  <!-- –§–ò–õ–¨–¢–† -->
  <div class="filter-block">
    <h2>–ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä</h2>

    <input id="searchVin" placeholder="–ü–æ–∏—Å–∫ –ø–æ VIN" oninput="loadVehicles()">

    <select id="filterType" onchange="loadVehicles()">
      <option value="">–í—Å–µ</option>
      <option value="regular">–û–±—ã—á–Ω—ã–µ</option>
      <option value="tral">–¢—Ä–∞–ª—ã</option>
    </select>
  </div>

</div>

<h2>–°–ø–∏—Å–æ–∫ –º–∞—à–∏–Ω</h2>
<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
        <th>VIN</th>
        <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–î–∞—Ç–∞</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        <th>–¢–∏–ø</th>
        <th>–ì—Ä—É–∑</th>
        <th>–í–µ—Å</th>
        <th>–ì–∞–±–∞—Ä–∏—Ç—ã</th>
        <th>–ú–∏–Ω—Ç—Ä–∞–Ω—Å</th>
        <th>–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ</th>
        <th>–§–æ—Ç–æ</th>
        <th>–£–¥–∞–ª–∏—Ç—å</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>
</div>
<script>

// üîê –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
function logout() {
  localStorage.removeItem("token");
  window.location.href = "/login.html";
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
function authHeader() {
  return {
    "Authorization": "Bearer " + localStorage.getItem("token")
  };
}

async function deleteVehicle(id) {
  const confirmDelete = confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –º–∞—à–∏–Ω—É?");
  if (!confirmDelete) return;

  await fetch(`/api/vehicles/${id}`, {
    method: "DELETE",
    headers: authHeader()
  });

  loadVehicles();
}

async function updateFlags(id, mintrans, escort) {
  const res = await fetch("/api/vehicles", {
    headers: authHeader()
  });

  const vehicles = await res.json();
  const current = vehicles.find(v => v.id === id);

  const newMintrans =
    mintrans === null ? current.mintrans_permit : mintrans;

  const newEscort =
    escort === null ? current.escort_received : escort;

  await fetch("/api/update-flags", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...authHeader()
    },
    body: JSON.stringify({
      id,
      mintrans_permit: newMintrans,
      escort_received: newEscort
    })
  });

  loadVehicles();
}

async function updateMintrans(id, value) {
  await fetch("/api/update-mintrans", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...authHeader()
    },
    body: JSON.stringify({ id, value })
  });

  loadVehicles();
}

async function loadVehicles() {
  const search = document.getElementById("searchVin").value;
  const typeFilter = document.getElementById("filterType").value;

  const res = await fetch("/api/vehicles", {
    headers: authHeader()
  });

  if (res.status === 401) {
    logout();
    return;
  }

  const data = await res.json();

  const list = document.getElementById("list");
  list.innerHTML = "";

  const filtered = data
    .filter(v => !search || (v.vin && v.vin.includes(search)))
    .filter(v => !typeFilter || v.transport_type === typeFilter);

  filtered.forEach(v => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${v.id}</td>
      <td>${v.name || "-"}</td>
      <td>${v.vin}</td>
      <td>${v.company}</td>
      <td>${v.status}</td>
      <td>${new Date(v.created_at).toLocaleString()}</td>
      <td>
        <select onchange="changeStatus(${v.id}, this.value)">
          ${[
            "–ì—Ä–∞–Ω–∏—Ü–∞ –ò—Ä–∫–µ—à—Ç–∞–º",
            "–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã",
            "–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ",
            "–ü–æ–ª—É—á–µ–Ω–æ —Å–ø–µ—Ü—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ú–∏–Ω—Ç—Ä–∞–Ω—Å",
            "–í –ø—É—Ç–∏",
            "–°—Ç–æ—è–Ω–∫–∞ –ö–∞—Ä–∞—Ç–∞–π",
            "–†–∞—Å—Ç–∞–º–æ–∂–∫–∞",
            "–†–∞—Å—Ç–∞–º–æ–∂–µ–Ω–∞",
            "–ù–∞ –±–∞–∑–µ –∫–æ–º–ø–∞–Ω–∏–∏",
            "–ü–µ—Ä–µ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∞"
          ].map(status =>
            `<option value="${status}" ${v.status === status ? "selected" : ""}>${status}</option>`
          ).join("")}
        </select>
      </td>
      <td>
        ${v.transport_type === "tral"
            ? "–¢—Ä–∞–ª"
            : "–û–±—ã—á–Ω–∞—è"}
    </td>
      <td>${v.cargo_name || "-"}</td>
      <td>${v.cargo_weight || "-"}</td>
      <td>${v.cargo_size || "-"}</td>
      <td>
        ${v.transport_type !== "tral"
          ? "-"
          : `<input type="checkbox"
              ${v.mintrans_permit ? "checked" : ""}
              onchange="updateMintrans(${v.id}, this.checked)">`
        }
      </td>
      <td>
        <input type="checkbox"
          ${v.escort_received ? "checked" : ""}
          onchange="updateFlags(${v.id}, null, this.checked)">
      </td>
      <td>
        ${v.photo ? `<img src="/uploads/${v.photo}" width="80"><br>` : ""}
        <input type="file" onchange="uploadPhoto(${v.id}, this.files[0])">
      </td>
      <td>
        <button onclick="deleteVehicle(${v.id})" style="color:red;">
          –£–¥–∞–ª–∏—Ç—å
        </button>
      </td>
    `;

    list.appendChild(row);
  });
}

async function changeStatus(id, newStatus) {
  await fetch("/api/update-status", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...authHeader()
    },
    body: JSON.stringify({ id, status: newStatus })
  });

  loadVehicles();
}

async function addVehicle() {
  const name = document.getElementById("name").value;
  const vin = document.getElementById("vin").value;
  const company = document.getElementById("company").value;
  const status = document.getElementById("status").value;
  const transport_type = document.getElementById("transport_type").value;
  const cargo_name = document.getElementById("cargo_name").value;
  const cargo_weight = document.getElementById("cargo_weight").value;
  const cargo_size = document.getElementById("cargo_size").value;

  await fetch("/api/vehicles", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...authHeader()
    },
    body: JSON.stringify({
      name,
      vin,
      company,
      status,
      transport_type,
      cargo_name,
      cargo_weight,
      cargo_size
    })
  });

  loadVehicles();
}

async function uploadPhoto(id, file) {
  const formData = new FormData();
  formData.append("photo", file);

  await fetch(`/api/upload/${id}`, {
    method: "POST",
    headers: authHeader(),
    body: formData
  });

  loadVehicles();
}

document.getElementById("transport_type").addEventListener("change", function() {
  const cargoBlock = document.getElementById("cargoFields");

  if (this.value === "tral") {
    cargoBlock.style.display = "block";
  } else {
    cargoBlock.style.display = "none";
  }
});

loadVehicles();
</script>

</body>
</html>